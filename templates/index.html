<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Transaction Scheduler</title>
</head>
<body>
    <h1>Schedule a Bitcoin Transaction</h1>
    <form id="transaction-form" action="/schedule" method="post">

        <label for="network">Select network:</label><br>
        <select id="network" name="network" required>
            <option value="bitcoin">Bitcoin Mainnet</option>
            <option value="testnet" selected>Bitcoin Testnet</option>
        </select><br><br>
        
        <label for="mnemonic">Enter your mnemonic:</label><br>
        <input type="text" id="mnemonic" name="mnemonic" required><br><br>
        <label for="address-choice">How would you like to provide the recipient's address?</label><br>
        <input type="radio" id="direct" name="address_choice" value="direct" checked>
        <label for="direct">Enter a Bitcoin address</label><br>
        <input type="radio" id="public-key" name="address_choice" value="public_key">
        <label for="public-key">Enter a public key</label><br><br>

        <div id="address-field">
            <label for="recipient-address">Recipient's Bitcoin Address:</label><br>
            <input type="text" id="recipient-address" name="recipient_address"><br><br>
        </div>

        <div id="public-key-field" style="display: none;">
            <label for="public-key-input">Recipient's Public Key (hex):</label><br>
            <input type="text" id="public-key-input" name="public_key"><br><br>
        </div>

        <label for="amount">Enter amount (BTC):</label><br>
        <input type="number" id="amount" name="amount" step="0.00000001" required><br><br>

        <label for="fee-rate">Enter fee rate (satoshis/byte):</label><br>
        <input type="number" id="fee-rate" name="fee_rate" required><br><br>

        <label for="scheduled-time">Enter scheduled time (YYYY-MM-DD HH:MM:SS):</label><br>
        <input type="datetime-local" id="scheduled-time" name="scheduled_time" required><br><br>

        <button type="submit">Schedule Transaction</button>
    </form>

    <h2>Transactions List</h2>
    <ul id="transactions-list">
        {% for tx in transactions %}
        <li>
            <strong>ID:</strong> {{ loop.index }}<br>
            <strong>Scheduled Time:</strong> {{ tx['scheduled_time'].strftime('%Y-%m-%d %H:%M:%S') }}<br>
            <strong>Recipient Address:</strong> {{ tx['recipient_address'] }}<br>
            <strong>Amount:</strong> {{ tx['amount'] }} BTC<br>
            <strong>Status:</strong> {{ tx['status'] }}<br>
            <button onclick="deleteTransaction()">Delete</button>
        </li>
        {% endfor %}
    </ul>

    <script>
        const transactionsList = document.getElementById('transactions-list');
        const form = document.getElementById('transaction-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(form);
            const response = await fetch('/schedule', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                alert('Transaction scheduled successfully!');

                // Add the new transaction to the list dynamically
                const newTransaction = document.createElement('li');
                newTransaction.innerHTML = `
                    <strong>ID:</strong> ${transactionsList.children.length + 1}<br>
                    <strong>Scheduled Time:</strong> ${data.transaction.scheduled_time}<br>
                    <strong>Recipient Address:</strong> ${data.transaction.recipient_address}<br>
                    <strong>Amount:</strong> ${data.transaction.amount} BTC<br>
                    <strong>Status:</strong> ${data.transaction.status}<br>
                `;
                transactionsList.appendChild(newTransaction);
                location.reload();

                // Clear the form
                form.reset();
            } else {
                const error = await response.json();
                alert('Error: ' + error.error);
            }
        });

        const addressChoiceRadios = document.getElementsByName('address_choice');
        const addressField = document.getElementById('address-field');
        const publicKeyField = document.getElementById('public-key-field');

        addressChoiceRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'direct') {
                    addressField.style.display = 'block';
                    publicKeyField.style.display = 'none';
                } else if (radio.value === 'public_key') {
                    addressField.style.display = 'none';
                    publicKeyField.style.display = 'block';
                }
            });
        });
    </script>

    </div>
        <div class="section" id="broadcast-transaction">
            <h2>Broadcast a Transaction</h2>
            <form id="broadcast-form">
                <label for="tx-id">Transaction ID</label>
                <input type="text" id="tx-id" name="tx_id" placeholder="Enter transaction ID" required>
                <button type="button" onclick="broadcastTransaction()">Broadcast Transaction</button>
            </form>
        </div>
    </div>

    <script>
        const baseURL = "http://localhost:5000";

        async function listTransactions() {
            const response = await fetch(`${baseURL}/transactions`);
            const data = await response.json();
            const transactionsList = document.getElementById('transactions-list');
            transactionsList.innerHTML = '';

            data.forEach(tx => {
                const li = document.createElement('li');
                li.textContent = `ID: ${tx.id}, Scheduled Time: ${tx.scheduled_time}, Status: ${tx.status}`;
                transactionsList.appendChild(li);
            });
        }

        async function scheduleTransaction() {
            const mnemonic = document.getElementById('mnemonic').value;
            const recipient = document.getElementById('recipient').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const feeRate = parseFloat(document.getElementById('fee-rate').value);
            const scheduledTime = document.getElementById('scheduled-time').value;

            const response = await fetch(`${baseURL}/schedule`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mnemonic, recipient, amount, fee_rate: feeRate, scheduled_time: scheduledTime })
            });

            const data = await response.json();
            alert(data.message);
        }

        async function broadcastTransaction() {
            const id = document.getElementById('transaction-id').value;

            const response = await fetch(`${baseURL}/broadcast`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });

            const data = await response.json();
            alert(data.message);
        }

        async function deleteTransaction() {
            const id = document.getElementById('delete-id').value;

            const response = await fetch(`${baseURL}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });

            const data = await response.json();
            alert(data.message);
        }
    </script>
</body>
</html>
